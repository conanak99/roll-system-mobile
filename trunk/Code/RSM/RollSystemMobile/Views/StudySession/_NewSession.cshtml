@model RollSystemMobile.Models.RollCall
@{
    Layout = null;
}
<fieldset style="margin: 0 0 -20px -20px">
    <dl class="dl-horizontal">
        @Html.HiddenFor(model => model.RollCallID)
        @Html.HiddenFor(model => model.ClassID)
        <dt>Date</dt>
        <dd>
            @{ DateTime TimeShow;
               if (DateTime.Today > Model.BeginDate)
               {
                   TimeShow = DateTime.Today.AddDays(1);

               }
               else
               {
                   TimeShow = Model.BeginDate;
               }
            }
            <div class="input-append date" data-date="@Html.FormatDate(TimeShow)" id="begindate" data-date-format="dd-mm-yyyy">
                <input class="span2" name="_SessionDate" id="SessionDate" style="width: 100px" size="16" type="text"
                    value="@Html.FormatDate(TimeShow)" readonly><span class="add-on"><i class="icon-th"></i></span>
            </div>
        </dd>
        <dt>StartTime</dt>
        <dd>
            <select id="_StartTime" name="_StartTime">
            </select>
        </dd>
        <dt>Instructor</dt>
        <dd>
            <select id="InstructorID" name="InstructorID">
            </select></dd>
        <dt>Note</dt>
        <dd>
            <input name="Note" class="span3" /></dd>
    </dl>
</fieldset>
<script>
    var now = new Date();
    var endDate = new Date('@Model.EndDate.ToLongDateString()');
    //Tru them 1 ngay, ko lay ngay thu 7 cuoi cung
    endDate.setDate(endDate.getDate() - 2);
    //Nam trong hom nay toi end date, tru chu nhat
    $("#begindate").datepicker({
        onRender: function (date) {
            return date.valueOf() < now.valueOf() ||
                   date.valueOf() > endDate.valueOf()
                   || date.getDay() == 0 ? 'disabled' : '';
        }
    }).on('changeDate', function (ev) {
        var selectedDate = ev.date;
        var formatedSelectedDate = (selectedDate.getMonth() + 1) + '-' + selectedDate.getDate() + '-' + selectedDate.getFullYear();
        findAvaiableTime(formatedSelectedDate);
    });

    $('#_StartTime').change(function () {
        var selectedTime = $('#_StartTime :selected').attr("value");
        var selectedDate = $('#SessionDate').val();

        findAvaibleInstructor(selectedTime, selectedDate);
    });


    function findAvaiableTime(selectedDate)
    {
        var rollID = '@Model.RollCallID';
        //Lay data de gui
        var data = 'RollCallID=' + rollID + '&SelectedDate=' + selectedDate;

        //Clear 2 cai select
        $('#_StartTime, InstructorID').html('');

        //Dua ket qua vao select List
        $.getJSON('@Url.Action("GetAvaibleSessionTime")', data, function (result) {
            var html = "";
            $.each(result, function (index, item_result) {
                html += ('<option value="' + item_result.time + '" >' + item_result.time + '</option>');
            });
            $("#_StartTime").html(html);
        });
    }

    function findAvaibleInstructor(selectedTime, selectedDate) {
        var rollID = '@Model.RollCallID';
        var data = 'RollCallID=' + rollID + '&SelectedTime=' + selectedTime + '&InSelectedDate=' + selectedDate;

        //Clear instructor select
        $('#InstructorID').html('');

        //Dua ket qua vao select List
        $.getJSON('@Url.Action("GetAvaibleInstructor")', data, function (result) {
            var html = "";
            $.each(result, function (index, item_result) {
                html += ('<option value="' + item_result.id + '" >' + item_result.name + '</option>');
            });
            $("#InstructorID").html(html);
        });
    }

    //Thuc hien load select list
    $(document).ready(function () {
        findAvaiableTime('@TimeShow.ToString("MM-dd-yyyy")');
        setTimeout(function () {
            var selectedTime = $("#_StartTime").val();
            var selectedDate = $('#SessionDate').val();
            findAvaibleInstructor(selectedTime, selectedDate);    
         }, 500);
    });
</script>
