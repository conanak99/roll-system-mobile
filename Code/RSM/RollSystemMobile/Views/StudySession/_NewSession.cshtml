@model RollSystemMobile.Models.RollCall
@{
    Layout = null;
}
<fieldset style="margin: 0 0 -20px -20px">
    <dl class="dl-horizontal">
        @Html.HiddenFor(model => model.RollCallID)
        @Html.HiddenFor(model => model.ClassID)
        <dt class="martop-5">Date</dt>
        <dd>
            <div class="input-append date" data-date="@Html.FormatDate(DateTime.Today)" id="begindate_New" data-date-format="dd-mm-yyyy">
                <input class="span2" name="_SessionDate" id="SessionDate" style="width: 100px" size="16" type="text"
                    value="@Html.FormatDate(DateTime.Today)" readonly><span class="add-on"><i class="icon-th"></i></span>
            </div>
        </dd>
        <dt class="martop-5">StartTime</dt>
        <dd>
            <select id="_StartTime_New" name="_StartTime" style="width:80px">
            </select>
        </dd>
        <dt class="martop-5">Instructor</dt>
        <dd>
            <select id="InstructorID_New" name="InstructorID">
            </select></dd>
        <dt class="martop-5">Note (<font color="red">*</font>)</dt>
        <dd>
            <input type="text" id="Note_New" name="Note" class="span3" /></dd>
    </dl>
</fieldset>
<script>
    var now = new Date();
    var endDate = new Date('@Model.EndDate.ToLongDateString()');
    //Tru them 1 ngay, ko lay ngay thu 7 cuoi cung
    endDate.setDate(endDate.getDate() - 2);
    //Nam trong hom nay toi end date, tru chu nhat
    var begindate_New = $("#begindate_New").datepicker({
        onRender: function (date) {
            return date.valueOf() < now.valueOf() ||
                   date.valueOf() > endDate.valueOf()
                   || date.getDay() == 0 ? 'disabled' : '';
        }
    }).on('changeDate', function (ev) {
        var selectedDate = ev.date;
        var formatedSelectedDate = (selectedDate.getMonth() + 1) + '-' + selectedDate.getDate() + '-' + selectedDate.getFullYear();
        findAvaiableTime(formatedSelectedDate, formatedSelectedDate);
        begindate_New.hide();
    }).data('datepicker');

    $('#_StartTime_New').change(function () {
        var selectedTime = $('#_StartTime_New :selected').attr("value");
        var selectedDate = $('#SessionDate').val();

        findAvaibleInstructor(selectedTime, selectedDate, selectedDate);
    });


    function findAvaiableTime(fromDate, toDate)
    {
        var rollID = '@Model.RollCallID';
        //Lay data de gui
        var data = 'RollCallID=' + rollID + '&FromDate=' + fromDate + '&ToDate=' + toDate;

        //Clear 2 cai select
        $('#_StartTime_New, #InstructorID_New').html('');

        //Dua ket qua vao select List
        $.getJSON('@Url.Action("GetAvaibleSessionTime")', data, function (result) {
            var html = "";
            $.each(result, function (index, item_result) {
                html += ('<option value="' + item_result.time + '" >' + item_result.time + '</option>');
            });
            $("#_StartTime_New").html(html);

            //Hien luon select list cho instructor
            var selectedTime = $("#_StartTime_New").val();
            var selectedDate = $('#SessionDate').val();
            findAvaibleInstructor(selectedTime, selectedDate, selectedDate);
        });
    }

    function findAvaibleInstructor(selectedTime, fromDate, toDate) {
        var rollID = '@Model.RollCallID';
        var data = 'RollCallID=' + rollID + '&SelectedTime=' + selectedTime
                   + '&InFromDate=' + fromDate + '&InToDate=' + toDate;

        //Clear instructor select
        $('#InstructorID_New').html('');

        //Dua ket qua vao select List
        $.getJSON('@Url.Action("GetAvaibleInstructor")', data, function (result) {
            var html = "";
            $.each(result, function (index, item_result) {
                html += ('<option value="' + item_result.id + '" >' + item_result.name + '</option>');
            });
            $("#InstructorID_New").html(html);
        });
    }

    //Thuc hien load select list
    $(document).ready(function () {
        findAvaiableTime('@DateTime.Today.ToString("MM-dd-yyyy")', '@DateTime.Today.ToString("MM-dd-yyyy")');
        setTimeout(function () {
            var selectedTime = $("#_StartTime_New").val();
            var selectedDate = $('#SessionDate').val();
            findAvaibleInstructor(selectedTime, selectedDate, selectedDate);    
         }, 500);
    });
</script>
